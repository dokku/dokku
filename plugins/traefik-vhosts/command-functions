#!/usr/bin/env bash
source "$PLUGIN_CORE_AVAILABLE_PATH/common/functions"
source "$PLUGIN_AVAILABLE_PATH/proxy/command-functions"
source "$PLUGIN_AVAILABLE_PATH/traefik-vhosts/internal-functions"
set -eo pipefail
[[ $DOKKU_TRACE ]] && set -x

cmd-traefik-labels-add() {
  declare desc="adds container label to app for specified proxy"
  declare cmd="traefik:labels:add"
  [[ "$1" == "$cmd" ]] && shift 1

  cmd-proxy-labels-add "proxy:labels:add" "traefik" "$@"
}

cmd-traefik-labels-remove() {
  declare desc="removes container label from app for specified proxy"
  declare cmd="traefik:labels:remove"
  [[ "$1" == "$cmd" ]] && shift 1

  cmd-proxy-labels-remove "proxy:labels:remove" "traefik" "$@"
}

cmd-traefik-labels-show() {
  declare desc="shows container labels for app for specified proxy"
  declare cmd="traefik:labels:show"
  [[ "$1" == "$cmd" ]] && shift 1

  cmd-proxy-labels-show "proxy:labels:show" "traefik" "$@"
}

cmd-traefik-report() {
  declare desc="displays a traefik report for one or more apps"
  declare cmd="traefik:report"
  [[ "$1" == "$cmd" ]] && shift 1
  declare APP="$1" INFO_FLAG="$2"
  local FORMAT="stdout"

  if [[ -n "$APP" ]] && [[ "$APP" == "--format" ]]; then
    FORMAT="$INFO_FLAG"
    APP=""
    INFO_FLAG=""
  elif [[ -n "$INFO_FLAG" ]] && [[ "$INFO_FLAG" == "--format" ]]; then
    FORMAT="$3"
    INFO_FLAG=""
  elif [[ -n "$APP" ]] && [[ "$APP" == --* ]]; then
    INFO_FLAG="$APP"
    APP=""
  fi

  if [[ -z "$APP" ]] && [[ -z "$INFO_FLAG" ]]; then
    INFO_FLAG="true"
  fi

  if [[ -z "$APP" ]]; then
    for app in $(dokku_apps); do
      cmd-traefik-report-single "$app" "$INFO_FLAG" "$FORMAT" | tee || true
    done
  else
    cmd-traefik-report-single "$APP" "$INFO_FLAG" "$FORMAT"
  fi
}

cmd-traefik-report-single() {
  declare APP="$1" INFO_FLAG="$2" FORMAT="${3:-stdout}"
  if [[ "$INFO_FLAG" == "true" ]]; then
    INFO_FLAG=""
  fi
  verify_app_name "$APP"
  local flag_map=(
    "--traefik-api-enabled: $(fn-traefik-api-enabled)"
    "--traefik-api-vhost: $(fn-traefik-api-vhost)"
    "--traefik-basic-auth-password: $(fn-traefik-basic-auth-password)"
    "--traefik-basic-auth-username: $(fn-traefik-basic-auth-username)"
    "--traefik-challenge-mode: $(fn-traefik-challenge-mode)"
    "--traefik-dashboard-enabled: $(fn-traefik-dashboard-enabled)"
    "--traefik-dns-provider: $(fn-traefik-dns-provider)"
    "--traefik-image: $(fn-traefik-image)"
    "--traefik-letsencrypt-email: $(fn-traefik-letsencrypt-email)"
    "--traefik-letsencrypt-server: $(fn-traefik-letsencrypt-server)"
    "--traefik-log-level: $(fn-traefik-log-level)"
    "--traefik-http-entry-point: $(fn-traefik-http-entry-point)"
    "--traefik-https-entry-point: $(fn-traefik-https-entry-point)"
  )

  # Get dns-provider-* env vars and add them (masked for stdout, unmasked for json)
  local dns_provider_env_vars
  dns_provider_env_vars="$(fn-traefik-dns-provider-env-vars)"
  if [[ -n "$dns_provider_env_vars" ]]; then
    while IFS= read -r line; do
      local key value
      key="$(echo "$line" | cut -d' ' -f1)"
      value="$(echo "$line" | cut -d' ' -f2-)"
      if [[ -n "$key" ]]; then
        if [[ "$FORMAT" == "json" ]]; then
          flag_map+=("--traefik-${key}: ${value}")
        else
          flag_map+=("--traefik-${key}: *******")
        fi
      fi
    done <<<"$dns_provider_env_vars"
  fi

  if [[ "$FORMAT" == "json" ]]; then
    local json_output="{}"
    for flag in "${flag_map[@]}"; do
      local key value
      key="$(echo "$flag" | cut -d':' -f1 | sed 's/^--traefik-//')"
      value="$(echo "$flag" | cut -d':' -f2- | sed 's/^ //')"
      json_output="$(echo "$json_output" | jq -c --arg key "$key" --arg value "$value" '. + {($key): $value}')"
    done
    echo "$json_output"
  elif [[ -z "$INFO_FLAG" ]]; then
    dokku_log_info2_quiet "${APP} traefik information"
    for flag in "${flag_map[@]}"; do
      key="$(echo "${flag#--}" | cut -f1 -d' ' | tr - ' ')"
      dokku_log_verbose "$(printf "%-30s %-25s" "${key^}" "${flag#*: }")"
    done
  else
    local match=false
    local value_exists=false
    for flag in "${flag_map[@]}"; do
      valid_flags="${valid_flags} $(echo "$flag" | cut -d':' -f1)"
      if [[ "$flag" == "${INFO_FLAG}:"* ]]; then
        value=${flag#*: }
        size="${#value}"
        if [[ "$size" -ne 0 ]]; then
          echo "$value" && match=true && value_exists=true
        else
          match=true
        fi
      fi
    done
    [[ "$match" == "true" ]] || dokku_log_fail "Invalid flag passed, valid flags:${valid_flags}"
  fi
}

cmd-traefik-logs() {
  declare desc="display traefik logs from command line"
  declare cmd="traefik:logs"
  [[ "$1" == "$cmd" ]] && shift 1
  local NUM="100" TAIL=false

  local TEMP=$(getopt -o htn: --long help,tail,num: -n 'dokku traefik:logs' -- "$@")
  local EXIT_CODE="$?"
  if [[ "$EXIT_CODE" != 0 ]]; then
    fn-traefik-logs-usage >&2
    exit 1
  fi
  eval set -- "$TEMP"

  while true; do
    case "$1" in
      -t | --tail)
        local TAIL=true
        shift
        ;;
      -n | --num)
        local NUM="$2"
        shift 2
        ;;
      --)
        shift
        break
        ;;
      *) dokku_log_fail "Internal error" ;;
    esac
  done

  fn-traefik-logs "$TAIL" "$NUM"
}

cmd-traefik-show-config() {
  declare desc="display traefik config"
  declare cmd="traefik:show-config"
  [[ "$1" == "$cmd" ]] && shift 1

  if ! fn-is-compose-installed; then
    dokku_log_fail "Required docker compose plugin is not installed"
  fi

  local TMP_COMPOSE_FILE=$(mktemp "/tmp/dokku-${DOKKU_PID}-${FUNCNAME[0]}.XXXXXX")
  trap "rm -rf '$TMP_COMPOSE_FILE' >/dev/null" RETURN INT TERM EXIT

  fn-traefik-template-compose-file "$TMP_COMPOSE_FILE"
  cat "$TMP_COMPOSE_FILE"
}

cmd-traefik-start() {
  declare desc="Starts the traefik server"
  declare cmd="traefik:start"
  [[ "$1" == "$cmd" ]] && shift 1

  if ! fn-is-compose-installed; then
    dokku_log_fail "Required docker compose plugin is not installed"
  fi

  local TMP_COMPOSE_FILE=$(mktemp "/tmp/dokku-${DOKKU_PID}-${FUNCNAME[0]}.XXXXXX")
  trap "rm -rf '$TMP_COMPOSE_FILE' >/dev/null" RETURN INT TERM EXIT

  fn-plugin-property-write "traefik" "--global" "proxy-status" "started"
  touch "${DOKKU_LIB_ROOT}/data/traefik/traefik-acme.json"
  chmod 600 "${DOKKU_LIB_ROOT}/data/traefik/traefik-acme.json"
  fn-traefik-template-compose-file "$TMP_COMPOSE_FILE"
  if ! "$PLUGIN_CORE_AVAILABLE_PATH/common/common" compose-up "traefik" "$TMP_COMPOSE_FILE"; then
    return 1
  fi
}

cmd-traefik-stop() {
  declare desc="Stops the traefik server"
  declare cmd="traefik:stop"
  [[ "$1" == "$cmd" ]] && shift 1

  if ! fn-is-compose-installed; then
    dokku_log_fail "Required docker compose plugin is not installed"
  fi

  local TMP_COMPOSE_FILE=$(mktemp "/tmp/dokku-${DOKKU_PID}-${FUNCNAME[0]}.XXXXXX")
  trap "rm -rf '$TMP_COMPOSE_FILE' >/dev/null" RETURN INT TERM EXIT

  fn-plugin-property-write "traefik" "--global" "proxy-status" "stopped"
  touch "${DOKKU_LIB_ROOT}/data/traefik/traefik-acme.json"
  chmod 600 "${DOKKU_LIB_ROOT}/data/traefik/traefik-acme.json"
  fn-traefik-template-compose-file "$TMP_COMPOSE_FILE"
  if ! "$PLUGIN_CORE_AVAILABLE_PATH/common/common" compose-down "traefik" "$TMP_COMPOSE_FILE"; then
    return 1
  fi
}
